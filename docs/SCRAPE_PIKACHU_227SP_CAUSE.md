# ピカチュウ(見返り美人) 227/S-P の画像・販売価格が取れない原因

**現象**: ターゲットは ピカチュウ【P】{227/S-P} [S-P] 158,000円 なのに、380円の ピカチュウex(ノーマル仕様)【-】{227/742} [MC] の画像と価格が取られている。

---

## 原因の整理

### 1. 型番が「指定されているとき」に、型番一致した商品だけを候補にしていない

- 現状の流れ:
  1. 在庫ありの全商品について `name_match`（名前マッチ）を付けている。
  2. **名前マッチしたものだけ**を `matched_items` に集めている。
  3. `matched_items` の**最安値**を返している。

- 問題:
  - ターゲットは **型番 227/S-P** 付きで検索している。
  - ところが「名前マッチ」には **型番を見ていない**。
  - そのため次の両方が `name_match=True` で入る:
    - 正しい商品: ピカチュウ【P】{227/S-P} [S-P] 158,000円（型番一致）
    - 別カード: ピカチュウex(ノーマル仕様)【-】{227/742} [MC] 380円（型番は 227/742 で不一致）
  - 「ピカチュウ」が含まれるのでどちらも名前マッチ True → 最安値で **380円** が選ばれている。

**結論**: 型番（`card_number`）が渡されているときは、**型番一致した商品だけ**を候補にし、その中で名前マッチしたものの最安値を取るべき。現状は「名前マッチだけ」で最安値を取っているため、型番の違う 227/742 の 380円 が選ばれている。

---

### 2. 型番の表記ゆれチェックが緩い（S-P と SV-P の混同）

- `_check_card_number_in_text("227/S-P", text)` の実装:
  - `"227/S-P"` を **英数字の塊** で分割 → `["227", "S", "P"]`
  - パターンは `"227" + 何か + "S" + 何か + "P"` が text に含まれるかだけを見ている。

- その結果:
  - 「かるいし【P】{**227/SV-P**} [SV-P]」には 227, S, V, P の順で出てくるので、`"227.*S.*P"` にマッチする。
  - つまり **227/S-P** と **227/SV-P** がどちらも「型番一致」と判定されている。
  - 本来は **S-P**（プロモの一種）と **SV-P**（別のセット・別カード）は区別すべき。

- 今回の 380円 問題の直接原因ではないが、「かるいし」が型番一致 True になる理由であり、型番ロジックを厳しくするときに S-P / SV-P を区別する必要がある。

---

### 3. フォールバック（「該当カード名を含む商品を選択」）で型番を見ていない

- ログの「在庫ありリストから該当カード名(ピカチュウ(見返り美人))を含む商品を選択: ピカチュウex(ノーマル仕様)… 380円」は、**名前だけ**で「ピカチュウ」を含む商品を集め、その最安値を取っている。
- 型番 227/S-P が指定されていても、このフォールバックでは型番一致を要求していない。
- そのため、227/742 の「ピカチュウex」が「該当カード名を含む」として選ばれ、380円・その画像が返っている。

---

## まとめ（修正はまだしなくてよい、原因だけ）

| 原因 | 内容 |
|------|------|
| **主原因** | 型番（227/S-P）が指定されているのに、**型番一致した商品に絞らず**「名前マッチしたものの最安値」だけを取っている。そのため型番の違う ピカチュウex 227/742 380円 が選ばれ、正しい ピカチュウ【P】227/S-P 158,000円 が選ばれていない。 |
| **副原因1** | 型番チェックが「227」「S」「P」の順で出てくれば OK になっており、**S-P と SV-P を区別していない**。 |
| **副原因2** | 「該当カード名を含む商品を選択」のフォールバックで型番を見ておらず、名前だけで最安値を取っている。 |

**修正の方向性（参考）**  
- 型番が渡されているときは「型番一致 **かつ** 名前マッチ」したものだけを候補にし、その中で最安値を返す。  
- 型番の表記は、可能なら **S-P と SV-P を区別**する（例: スラッシュ区切りの塊 "S-P" を 1 単位として扱うなど）。  
- フォールバックでも、型番指定がある場合は型番一致したものに限定する。

---

## 補足: 「未開封」が付いている商品より、付いていない方を取りたい

**現象**: 型番一致＋名前マッチで複数候補があるとき、現状は**最安値**を選んでいる。その結果、  
「ピカチュウ(未開封)【P】{227/S-P} [S-P] 308,000円」が選ばれ、「ピカチュウ(見返り美人)」や「ピカチュウ【P】{227/S-P}」のような**未開封と書いていない**商品（例: 158,000円）が選ばれないことがある。

**希望**: 同じ型番・同じカード名で複数ヒットしたときは、**商品名に「未開封」が含まれないものを優先**して取りたい（未開封は別バリエーションとして扱いたい）。

**修正の方向性（参考・未実装）**  
- 型番一致＋名前マッチした候補が複数あるとき、「未開封」が商品名に含まれないものを優先する。  
  - 例: まず「未開封」を含まないものだけに絞り、その中で最安値を取る。  
  - または、「未開封」を含まないものがあればそれだけを候補にし、なければ従来どおり最安値を取る。

---

## 見返りピカチュウ用の実装が他カードに与える影響

| 変更内容 | 他カードへの影響 |
|----------|------------------|
| **型番を「/」でブロック単位に** | ・型番が「091/064」など数字/数字のカードは従来どおり。  
・「XXX/S-P」「XXX/SV-P」のようにスラッシュ区切りの型番は、S-P と SM-P・SV-P が正しく区別され、**誤マッチが減る**。  
・ごく一部で、サイト表記と CSV の型番表記が違うとヒットしなくなる可能性はあるが、多くの場合は改善。 |
| **「未開封」を含まないものを優先** | ・「未開封」の商品が存在しないカードは**影響なし**（候補がそのまま、最安値を選択）。  
・「未開封」があるカードだけ、未開封でない方が選ばれる。 |
| **在庫あり・在庫なしをまとめてから選択** | ・**影響あり**。以前は「在庫ありが1件でもあれば在庫ありの最安値」だったが、今は「在庫あり＋在庫なしを合わせた中で未開封優先→最安値」になる。  
・そのため、**在庫ありより在庫なしの方が安いカードでは、在庫なしの価格・画像が返る**ことがある（見返り以外でも表示価格が変わる可能性あり）。  
・「在庫ありを優先したい」場合は、未開封優先のあと「在庫ありがあればその中で最安値」にすると他カードの挙動を従来に近づけられる。 |

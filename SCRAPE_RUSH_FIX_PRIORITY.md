# scrape_rush.py パターン別修正の優先順位と具体的な治し方

現状のコードは多くの場合で正しく動いているため、**既存のマッチを崩さない**ことを前提に、修正の優先順位と具体的な治し方をまとめました。一気に変えず、**1つずつ入れて挙動を確認**しやすい順にしています。

---

## 優先順位の考え方

- **リスクが低い**（今うまくいっているケースに影響しにくい）ものから手を付ける。
- **効果が分かりやすい**（誤画像が消える、取れなかった価格が取れる）ものを先に。
- **検証しやすい**（「このカードだけ」で試せる）ものから。
- パターン1（該当カードが検索結果にない）は**サイト側・検索結果の都合**なので、マッチ条件の変更では解消しにくく、最後に扱う。

---

## 第1優先：パターン5（マッチなし時の誤画像）

| 項目 | 内容 |
|------|------|
| **優先度** | 第1（最初にやる） |
| **理由** | **既存のマッチ済みケースに一切触らない**。変更するのは「マッチ0件のときの処理」だけなので、今うまく取れているカードには影響しない。誤った画像が表示される問題を一括で防げる。 |
| **リスク** | ほぼゼロ。マッチする商品がある行は従来どおり。マッチしない行は「画像なし」になるだけ。 |
| **検証** | これまで誤画像だったカード（ピカチュウex 086/064、カシオペア、タケルライコex、ルカリオ、地底探検隊など）で、画像が空になること・価格0円のままであることを確認。 |

### 具体的な治し方

1. **変更箇所**: `search_cardrush` 内の「マッチする商品が1件もない」ときの分岐。
2. **現状**: 「商品が見つかりませんでした。画像のみ取得を試みます...」で `page.query_selector("a[href*='/product/']")` の**先頭1件**から画像を取得し、`image_url` を埋めて返している。
3. **修正**: この「先頭1件の画像を取得するブロック」を**削除**する。マッチ0件のときは `image_url: ''` のまま返す（価格・在庫・URL は従来どおり `None` など）。
4. **結果**: マッチしない行は「販売価格0円・在庫なし・画像なし」となり、**別カードの画像は表示されない**。

---

## 第2優先：パターン3（大文字・小文字のゆれ）

| 項目 | 内容 |
|------|------|
| **優先度** | 第2 |
| **理由** | 正規化に「大文字→小文字」を足すだけなので**変更範囲が小さい**。今まで一致していたものは lower 後も一致する。ルカリオVstar など、表記ゆれで落ちているケースを拾える。 |
| **リスク** | 低い。アルファベット部分だけの違いなので、誤マッチが増えにくい。 |
| **検証** | ルカリオVstar(争奪戦プロモ) 305/S-P で、138,000円と正しい画像が取れること。既存で取れているカード（例: ピカチュウex など）が変わらないこと。 |

### 具体的な治し方

1. **変更箇所**: `_normalize_card_name` の**最後**で、返す直前に `.lower()` をかける（日本語はそのまま、英数字だけ小文字になる）。
2. **現状**: 括弧以降の切り落とし・記号削除のみ。大文字小文字はそのまま。
3. **修正**: `return name` の直前で `name = name.lower()` を実行し、`return name` で返す。これで「ルカリオVstar」も「ルカリオVSTAR」も同じ `ルカリオvstar` になり、部分文字列マッチで一致する。
4. **注意**: 既存の「ターゲット⊂商品」マッチは、両方とも lower になるので、今一致しているケースはそのまま一致する。

---

## 第3優先：パターン2（連続部分文字列でマッチしない）

| 項目 | 内容 |
|------|------|
| **優先度** | 第3 |
| **理由** | カシオペア・タケルライコex など「商品はあるが【SAR】で分断されてマッチしない」ケースを減らせる。一方で、マッチ条件を緩めると**別のカードを誤ってマッチさせる可能性**があるため、条件設計を少し慎重にしたい。 |
| **リスク** | 中。緩めすぎると「短いカード名が別商品に含まれる」ような誤マッチが出る可能性がある。 |
| **検証** | カシオペア SV6a 091/064、タケルライコex SV5K 095/071 で価格・画像が取れること。既存で取れているカード（特に短い名前・共通部分の多い名前）で誤マッチが増えていないこと。 |

### 具体的な治し方（案：双方向部分一致＋型番の併用）

1. **変更箇所**: `search_cardrush` 内の `name_match` を計算している部分。
2. **現状**: `normalized_target_name in normalized_product_name` のみ（ターゲットが商品に**一続きで**含まれるか）。
3. **修正案A（シンプル）**:  
   - **双方向部分一致**を追加する。  
     `(normalized_target_name in normalized_product_name)` **または**  
     `(normalized_product_name in normalized_target_name)`  
   - これで「カシオペア」だけの商品名も「カシオペア SV6a」ターゲットにマッチする（商品名がターゲットに含まれる）。  
   - ただし「カシオペア」は短いので、別セットの別カード名に「カシオペア」が含まれると誤マッチしうる。そのため **型番（card_number）の併用** を推奨（下記）。
4. **修正案B（型番を渡して厳しめに）**:  
   - 呼び出し元で `card_number` を渡す。  
   - `name_match` を  
     (双方向部分一致) **かつ** (商品名または商品URL に `card_number` が含まれる)  
     にすると、「同じ型番の別カード」を避けやすい。  
   - 例: カシオペア 091/064 → 商品名に「091/064」が含まれ、かつ「カシオペア」がターゲットか商品のどちらかに含まれる、でマッチ。
5. **実装の流れ**: まずは **修正案A（双方向部分一致）だけ** を入れ、カシオペア・タケルライコex で確認。問題がなければ **案B（card_number の併用）** を追加して、誤マッチをさらに減らす。

---

## 第4優先：パターン4（異体字・1文字違い）

| 項目 | 内容 |
|------|------|
| **優先度** | 第4 |
| **理由** | 地底探検隊（検 vs 険）のように、**判明している少数の同義漢字**を正規化に含めればよい。追加する文字ペアを限定すれば、既存マッチを崩しにくい。 |
| **リスク** | 低い。正規化で「検→険」など**既知のペアだけ**置換するので、影響範囲が読みやすい。 |
| **検証** | 地底探検隊 073/066 で、29,800円（または該当する価格）と正しい画像が取れること。他カードで誤マッチが増えていないこと。 |

### 具体的な治し方

1. **変更箇所**: `_normalize_card_name` の**記号削除の後・return の前**に、**同義漢字の統一**を1ステップ追加する。
2. **現状**: 括弧以降の切り落とし・記号削除のみ。
3. **修正**: 正規化用の辞書を用意し、**片方に寄せる**。  
   - 例: `{'険': '検'}` で、「地底探険隊」→「地底探検隊」に統一。  
   - 実装: 1文字ずつ走査するか、`str.maketrans` / `replace` で「よくある表記ゆれ」だけ置換。  
   - 追加するペアは**必要になったものだけ**（検⇔険 など）に留め、一覧をコメントで残す。
4. **注意**: 同音異字で別の意味のものは入れない（例: 検と険は「探検／探険」で同義なのでOK。それ以外の漢字は安易に追加しない）。

---

## 第5優先：パターン1（該当カードが検索結果にない）

| 項目 | 内容 |
|------|------|
| **優先度** | 第5（コード修正の最後、または「方針だけ決める」） |
| **理由** | **検索結果にそのカードが含まれていない**ため、マッチ条件をどう変えても「名前で選ぶ」ことができない。サイト側の在庫・検索仕様・型番の付け方に依存する。無理に緩めると別カードをマッチさせるリスクが大きい。 |
| **リスク** | コードで無理に拾おうとすると、型番だけでマッチさせることになり、**同じ型番の別カード**（ピカチュウex 086/064 の代わりにルチアのアピールを取る）を選んでしまう可能性が高い。 |
| **検証** | なし（コードで根本解決しない前提）。 |

### 具体的な治し方（コードでは限定的に）

1. **基本方針**: 「**検索結果にないカードは取れない**」と割り切り、**誤マッチ（別カードの価格・画像を取ること）を避ける**ことを優先する。
2. **コードでできること（任意・慎重に）**:  
   - 検索キーワードを「型番だけ」から「型番＋カード名の一部」などに変える**別パス**を試す（例: マッチ0件のときだけ、keyword を `card_number` から `target_name` に変えて再検索する、など）。  
   - 再検索は負荷・時間が増えるため、**オプションや回数制限**を付ける。  
   - それでも「ピカチュウex 086/064」がカードラッシュにない場合は、やはり0円・画像なしのままにする。
3. **ドキュメント**: README や SCRAPE_RUSH_MISMATCH_PATTERNS.md に「型番が複数カードで共通で、かつ該当カードが検索結果に含まれない場合は、販売価格・画像は取得できない」と明記する。

---

## 優先順位と実施順のまとめ

| 順番 | パターン | やること | リスク | 検証のしやすさ |
|------|----------|----------|--------|----------------|
| 1 | 5. 誤画像 | マッチ0件時は先頭1件の画像を取らない | ほぼゼロ | 誤画像だったカードで画像が空になることを確認 |
| 2 | 3. 大文字小文字 | `_normalize_card_name` の最後で `.lower()` | 低 | ルカリオVstar で価格・画像が取れることを確認 |
| 3 | 2. 連続部分文字列 | 双方向部分一致（＋必要なら card_number 併用） | 中 | カシオペア・タケルライコex で取れること、既存が崩れないこと |
| 4 | 4. 異体字 | `_normalize_card_name` で 検⇔険 等の統一 | 低 | 地底探検隊で取れること |
| 5 | 1. 検索結果にない | コードでは無理に拾わない。ドキュメントで明記。任意で再検索オプション | 高（無理にやると誤マッチ） | なし |

---

## 実装時の進め方（推奨）

1. **第1優先（パターン5）** だけ入れる → スクレイプを一部（例: 誤画像だった数枚）で実行し、画像が空になることを確認。
2. 問題なければ **第2優先（パターン3）** を追加 → ルカリオVstar などで価格・画像が取れることを確認。
3. 同様に **第3→第4** を1つずつ入れ、その都度「直したいカードで取れるか」「既存で取れていたカードが変わっていないか」を確認する。
4. パターン1は、上記が安定してから「再検索オプション」やドキュメントの追記だけにとどめる。

これで、既存のよく動いている部分を崩さず、パターンごとに不具合を確認しやすい順で直せます。

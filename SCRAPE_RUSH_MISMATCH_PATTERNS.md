# scrape_rush.py で販売価格・画像が取れない／誤るパターン一覧

カードラッシュ検索で「マッチしない」「誤った画像が表示される」原因となっているパターンをまとめたリストです。

---

## 1. 該当カードが検索結果にない（型番だけ被っている）

| 項目 | 内容 |
|------|------|
| **概要** | 型番で検索するとヒットするが、**欲しいカード名の商品が検索結果に含まれていない**。同じ型番の別カードだけが出ている。 |
| **例** | ピカチュウex 086/064 → 検索結果には「ルチアのアピール」「クセロシキのたくらみ」などだけ。ピカチュウex の商品はカードラッシュにない（または検索に出てこない）。 |
| **結果** | name_match する商品が 0 件 → 「画像のみ取得」で検索結果の**先頭1件**の画像が表示され、販売価格は 0 円。 |
| **備考** | 型番が複数カードで共通のため、キーワードだけでは区別できない。 |

---

## 2. 連続した部分文字列でマッチしない（【SAR】等で分断）

| 項目 | 内容 |
|------|------|
| **概要** | 該当カードは検索結果に**ある**が、名前マッチが「ターゲット正規化文字列が商品名の**連続した部分文字列**か」で判定しているため外れる。商品名に【SAR】{型番} などが入り、カード名とセット表記（SV6a 等）のあいだに文字が挟まる。 |
| **例** | カシオペア SV6a 091/064 → 商品「カシオペア【SAR】{091/064} [SV6a]」はあるが、正規化後は「カシオペアSAR{091/064}SV6a」。ターゲット「カシオペアSV6a」は一続きで含まれない。タケルライコex SV5K 095/071 も同様。 |
| **結果** | name_match: False → マッチ 0 件扱い → 先頭の別カードの画像と 0 円。 |
| **備考** | カードラッシュの商品名表記（【SAR】等）が、現在の「一続きの部分文字列」マッチと相性が悪い。 |

---

## 3. 表記ゆれ（大文字・小文字）

| 項目 | 内容 |
|------|------|
| **概要** | おたちゅうとカードラッシュで**アルファベットの大文字・小文字が違う**。正規化で大文字小文字を揃えていないため、部分文字列マッチしない。 |
| **例** | ルカリオVstar(争奪戦プロモ) 305/S-P → おたちゅうは「ルカリオV**s**tar」、カードラッシュは「ルカリオV**STAR**」。 |
| **結果** | 「ルカリオVstar」が「ルカリオVSTAR...」に含まれると判定されない → マッチ 0 件 → 先頭の別カードの画像と 0 円。 |
| **備考** | Vstar / VSTAR、ex / EX などのゆれがあり得る。 |

---

## 4. 表記ゆれ（異体字・1文字違い）

| 項目 | 内容 |
|------|------|
| **概要** | おたちゅうとカードラッシュで**漢字が1文字違う**（同音異字・異体字）。完全一致の部分文字列マッチでは拾えない。 |
| **例** | 地底探検隊 073/066 → おたちゅうは「地底探**検**隊」、カードラッシュは「地底探**険**隊」。検と険の違いでマッチしない。 |
| **結果** | 該当商品（一番左など）があるのに name_match: False → マッチ 0 件扱い → 別カードの画像と 0 円。 |
| **備考** | 探検／探険のように、表記ゆれでよくあるパターン。 |

---

## 5. マッチなし時の誤画像表示（仕様）

| 項目 | 内容 |
|------|------|
| **概要** | 上記 1〜4 のいずれかで「マッチする商品が 1 件もない」とき、**検索結果の先頭 1 件の画像**を取得して表示する現仕様のため、**別カードの画像**が表示される。 |
| **結果** | 正しいカードの行に、別カード（検索結果の先頭など）の画像が表示され、販売価格は 0 円。 |
| **備考** | 画像の誤表示を防ぐには「マッチなしのときは画像も返さない」ようにする必要がある。 |

---

## 一覧サマリ

| # | パターン名 | 原因の要約 | 例 |
|---|------------|------------|-----|
| 1 | 該当カードが検索結果にない | 型番は同じだが、そのカード名の商品が検索結果に含まれていない | ピカチュウex 086/064 |
| 2 | 連続部分文字列でマッチしない | 商品名に【SAR】等が入り、カード名とセット表記のあいだが分断される | カシオペア 091/064、タケルライコex 095/071 |
| 3 | 大文字・小文字のゆれ | 正規化で大文字小文字を揃えていない | ルカリオVstar 305/S-P（Vstar vs VSTAR） |
| 4 | 異体字・1文字違い | 漢字の表記ゆれで完全一致しない | 地底探検隊 073/066（検 vs 険） |
| 5 | マッチなし時の誤画像 | マッチ 0 件のときに先頭 1 件の画像を使う仕様 | 上記 1〜4 の結果として発生 |

---

## 修正の方向性（参考）

- **画像の誤表示**: マッチする商品が 1 件もないときは、先頭 1 件の画像を取らない（画像も空で返す）。
- **販売価格が取れない**:  
  - 型番（card_number）が商品名・URL に含まれていればマッチとみなす。  
  - カード名の双方向部分一致（ターゲット⊂商品 または 商品⊂ターゲット）。  
  - 正規化で大文字小文字を揃える、またはマッチ時に ignore case。  
  - 代表的な異体字（検⇔険など）の正規化や、あいまいマッチの検討。

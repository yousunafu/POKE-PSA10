# 本番デプロイ — めっちゃ分かりやすく説明

「インターネットで誰でも見られるようにする」＝**デプロイ** だと思ってください。

---

## いまのアプリは「2つのお店」で成り立っている

| 役割 | たとえ | いまローカルでやっていること |
|------|--------|------------------------------|
| **フロント** | お客さんが見る「お店の看板・メニュー・席」 | ターミナル2で `npm run dev` → ブラウザで見ている画面 |
| **バック（API）** | お店の奥の「厨房」。データ（CSV）を読んで料理（JSON）を作って渡す | ターミナル1で `uvicorn` → データを返している |

- 本番＝「24時間、誰がいつ見に来ても動いている状態」にすること。
- そのために「フロント」と「バック」を、**インターネット上に置く場所**を決める必要があります。

---

## 置き場所の選択肢は4つ

### 🅰️ A. 「看板だけ」ネットに出す（厨房は置かない）

**やること**  
データ（CSV）を、あらかじめ「読みやすい形（JSON）」に変換して、**画面のファイルと一緒に** Vercel に置く。  
＝ 厨房（API）は使わない。データは最初から「完成品のJSON」として同梱する。

- **どこに置く？** … **Vercel だけ**（無料で使える「看板用のレンタルスペース」）
- **イメージ** … メニューと「今日の一品リスト（JSON）」をセットで置いておく。お客さんはそのリストを読むだけ。

**いいところ**  
・いちばん簡単。Vercel に「frontend のビルド結果」を上げるだけ。  
・無料で始めやすい。  
・サーバー（厨房）を動かさないので、落ちたりメンテしたりしない。

**わるいところ**  
・データを更新したくなったら「JSON をまた作る → もう一度 Vercel にデプロイ」が必要。  
・「毎秒データを変えたい」ような使い方には向かない（週1回更新くらいなら十分）。

---

### 🅱️ B. 「看板」と「厨房」を別々のレンタルに置く

**やること**  
・**看板（フロント）** … Vercel に置く。  
・**厨房（API）** … Railway か Render に置く（FastAPI をそのまま動かす）。

- **どこに置く？** … **Vercel（フロント）** と **Railway または Render（API）** の2か所
- **イメージ** … 看板は Vercel、厨房は Railway。お客さんが「データちょうだい」と言うと、Vercel の画面が Railway の API に取りに行く。

**いいところ**  
・今の FastAPI のコードをほぼそのまま使える。  
・データ（CSV）を差し替えたり、API だけ再デプロイしたりすれば更新できる。

**わるいところ**  
・サービスが2つになる（Vercel と Railway の両方の設定が必要）。  
・Railway/Render の無料枠には制限があるので、使う量によっては有料になることがある。

---

### 🅲️ C. 全部 AWS の「一軒家」に置く

**やること**  
・フロントも API も、全部 **AWS** の上に置く。  
・フロント＝S3 + CloudFront など、API＝Lambda や ECS など。

- **どこに置く？** … **AWS だけ**（でも中身は「看板用の置き場」と「厨房用の置き場」で別々に設定）
- **イメージ** … 借りるのが「一軒家」。看板も厨房もその家の中に置くが、設定は多い。

**いいところ**  
・会社で「AWS で統一」という方針のときに合う。  
・あとから規模を大きくしやすい。

**わるいところ**  
・用語も画面も多く、最初は「何を選べばいいか」が分かりにくい。  
・このアプリの規模なら、A や B の方がシンプルで早い。

---

### 🅳️ D. 全部 Lightsail 1台に載せる（React も Python も）

**やること**  
・**1台の Lightsail**（例: 2GB プラン）に、**React（フロント）** と **Python/FastAPI（API）** の両方を載せる。  
・同じ台で **定期スクレイプ**（10:00・18:00 JST の cron）も回せる。

- **どこに置く？** … **Lightsail 1台だけ**
- **イメージ**  
  - Nginx が「看板」（React のビルド結果）を配信しつつ、「/api へのアクセス」を Python（uvicorn）に渡す。  
  - 同じサーバーに `merged_card_data.csv` を置き、FastAPI がそれを読む。  
  - cron で `scrape_otachu.py` → `scrape_rush.py` を実行し、CSV を更新。

**いいところ**  
・**React も Python もスクレイプも全部 1台・1サービス**で完結。  
・料金は Lightsail の月額（2GB なら約 $10）だけ。Vercel / Railway を別に契約しなくてよい。  
・「全部 AWS の Lightsail に寄せる」形にできる。

**わるいところ**  
・Nginx・systemd・cron の設定を自分でする必要がある。  
・OS のパッチや再起動も自分で管理。インスタンスが落ちたら全部止まるので監視が欲しい。

**技術的なイメージ（1台の中身）**  
1. **Nginx** … 80/443 で受け付け。`/` は React の静的ファイル（`npm run build` の結果）、`/api` は FastAPI（例: `http://127.0.0.1:8000`）にリバースプロキシ。  
2. **FastAPI** … systemd で uvicorn を常時起動。`merged_card_data.csv` を読んで JSON を返す。  
3. **cron** … 10:00・18:00 JST に `scrape_otachu.py` → `scrape_rush.py` を実行し、同じサーバー上の CSV を更新。

**具体的な手順**は [docs/LIGHTSAIL_ONE_SERVER.md](docs/LIGHTSAIL_ONE_SERVER.md) にまとめています。

---

## まとめ：どれを選べばいい？

| あなたの気持ち | 選ぶとよい |
|----------------|------------|
| とにかく**簡単に・無料で**公開したい | **A**（Vercel だけ・データは JSON で同梱） |
| 今の **FastAPI をそのまま**本番でも使いたい | **B**（Vercel + Railway/Render） |
| **会社で AWS を使う**決まりがある | **C**（AWS） |
| **React も Python もスクレイプも全部 1台に寄せたい** | **D**（Lightsail 1台に全部載せる） |

- **「まず動かしたい」** → A が一番分かりやすい。  
- **「API のまま運用したい」** → B。  
- **「AWS でやりたい」** → C（そのときは設定手順を別途まとめます）。  
- **「全部 Lightsail 1台で完結させたい」** → D（Nginx + React + FastAPI + cron を 1台で設定）。

---

## 用語の整理（ここだけ押さえればOK）

| 用語 | 意味（やさしく） |
|------|------------------|
| **デプロイ** | 作ったアプリを「本番用の置き場」に置いて、URL で誰でも見られるようにすること |
| **フロント** | ユーザーが見る画面（ボタン・テーブル・カード一覧など） |
| **バック / API** | データ（CSV）を読んで、画面用のデータ（JSON）を返すプログラム。今は FastAPI |
| **Vercel** | 画面（静的ファイル）を無料で置けるサービス。「看板用のレンタル」と思えばOK |
| **Railway / Render** | 常時動くサーバー（API）を簡単に置けるサービス。「厨房用のレンタル」と思えばOK |
| **静的JSON** | あらかじめ作ったデータファイル。API を呼ばずに、そのファイルを読むだけにするやり方（A でやること） |

---

「A でやりたい」「B でやりたい」など、決まったら「この方式で手順を書いて」と言ってもらえれば、その前提で**具体的な操作手順**を書きます。
